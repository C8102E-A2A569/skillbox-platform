# skillbox-platform
## Demo

### Spring Security
вынесена логика в отдельный модуль (starter) security-common

### JMS + rabbitMQ demonstration:
1) POST `{catalog-service}/catalog/enroll` 
    вначале записываем пользователя на курс (подаем заявку как бы), нам возвращается ссылка для оплаты
2) {payment-service}/payment/process
    Оплачиваем курс, если денег на счету > 100 (средняя цена курса) то пользователю отдается success! 
    А JMS Producer генерит событие, которое 

### Scheduler + JCA
* проверка устаревших платежей 
* отправка каждый день (раз в 24 часа) в notification-service (dummy сервис уведомлений) о том что пользователи ~~обалдели~~ не платят по счетам
* отправка будет происходить через JCA (по сути под капотом тоже будет rabbitMQ)


### Распределенные транзакции
архитектура продумывалась таким образом, чтобы данные в бд сохранялись только после успешных взаимодействий, 
то есть синхронный вызов (через REST), если нужно сразу что-то обработать
асинхронный - когда можно не ждать

### Important
@Scheduled работает каждые 10 секунд - это чисто для демонстрации работы их всего 2

1) проверяет есть ли непросроченные заявки на платеж, если да то отправляет в external сервис event через RabbitMQ
2) проверяет просроченные заявки и ставит им статус FAILED

**ЛОГИ сервисов**
`payment-service`
по идее тут проверка каждые 10 секунд на самом деле есть закомменченый Scheduled который выполняется раз в день, 10 секунд для демо 
- отправку по JCA каждые 10 сек в notification-service (это типо напоминания пользователям о том что они не оплатили курсы, если статус оплаты PENDING и если дата expiresAt не просрочена)
- каждые 10 секунд проверяет нет ли просроченных платежей

`catalog-service`
- логирует через JMS сообщения которые пришли от payment-service, это если пользователь успешно оплатил курс и его надо записать на него 

`notification-service`
- логирует (типо отправляет на почту) сообщения пользователям у которыз оплата в status = PENDING, expiresAt еще не настала (ну то есть не просроченный платеж) 

### В каком порядке показывать

1) register
   http://localhost:8082/api/v1/auth/register
2) login
   http://localhost:8082/api/v1/auth/authenticate
3) потом можно проверить что работают endpoint без аутентификации, например получить направления
   http://localhost:8082/catalog/directions
4) записаться на курс и получить URL оплаты
   http://localhost:8082/catalog/enroll
5) оплатить курс, вставив URL оплаты
   http://localhost:8080/payment/process?userId=6826598bfde10c7aa26a7f55&paymentLink=https://sberbank/pay/a1d94590-b15e-4bd1-a199-c2b3de296e9f&amount=1000
6) увидеть что в БД у user появилась отметка о том что он записан на курс
проверить лог catalog-service там должно быть уведомление о том что пользователь записан, (в логах сервиса появится запись)
это как раз через JMS payment-service -> catalog-service чтобы в catalog-service пометили что пользак записался
   
7) проверить scheduler отправку напоминаний
- поменять в БД в таблице `payment` status на PENDING
- подождать и увидеть что в логах notification-service появились записи, значит JCA работает

8) проверить scheduler удаление старых записей
- поменять в БД в таблице `payment` status на PENDING и дату на прошедшую (которая ДО сегоднящнего дня)
- подождать, увидеть в логах payment-service отметку о том что сброшен payment
- проверить в БД в таблице `payment` что status = FAILED

кайф!

URL на rabbitMQ 
http://localhost:15672/#/queues

очереди:
- **payments** (`payment-service` -> `catalog-service`)
для отправки события (сообщения) о том что пользователь оплатил чек (payment) и чтобы его щачислили на курс

`payment-service` - оплата

`catalog-service` - зачисление на курс

- **notification-queue** (`payment-service` -> `notification-service`)
каждый день в 00:00 происходит отсыл уведомлений пользователям, у которых чек еще не оплачен (если он не просрочен expiresDate позже чем now())
  (по факту каждые 10 секунд но это для демонстрации)

`payment-service` проверяет что нет просрочки и есть счет на оплату (payment) со статусом PENDING
`notification-service` это как бы external service на который мы через JCA шлем запрос на отсыл уведомления пользователям по почте


## ТЗ
### Лабораторная работа 1 (БЛПС)

**Вариант №804:** Skillbox — образовательная платформа с онлайн-курсами — [https://skillbox.ru/](https://skillbox.ru/). Бизнес-процесс: работа с каталогом, запись на курс (с оплатой).

Описать бизнес-процесс в соответствии с нотацией BPMN 2.0, после чего реализовать его в виде приложения на базе Spring Boot.

**Порядок выполнения работы:**

1. Выбрать один из бизнес-процессов, реализуемых сайтом из варианта задания.
2. Утвердить выбранный бизнес-процесс у преподавателя.
3. Специфицировать модель реализуемого бизнес-процесса в соответствии с требованиями BPMN 2.0.
4. Разработать приложение на базе Spring Boot, реализующее описанный на предыдущем шаге бизнес-процесс. Приложение должно использовать СУБД PostgreSQL для хранения данных, для всех публичных интерфейсов должны быть разработаны REST API.
5. Разработать набор curl-скриптов либо набор запросов для REST-клиента Insomnia для тестирования публичных интерфейсов разработанного программного модуля. Запросы Insomnia оформить в виде файла экспорта.
6. Развернуть разработанное приложение на сервере `helios`.

**Содержание отчёта:**

1. Текст задания.
2. Модель потока управления для автоматизируемого бизнес-процесса.
3. UML-диаграммы классов и пакетов разработанного приложения.
4. Спецификация REST API для всех публичных интерфейсов разработанного приложения.
5. Исходный код системы или ссылка на репозиторий с исходным кодом.
6. Выводы по работе.

**Swagger**

Система оплаты: http://localhost:8080/swagger-ui/index.html#
Система работы с каталогом: http://localhost:8082/swagger-ui/index.html#


